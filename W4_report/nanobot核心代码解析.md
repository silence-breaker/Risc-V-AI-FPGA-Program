# ğŸˆ Nanobot Agent æ ¸å¿ƒæ¶æ„è§£æ

> åŸºäº nanobot-ai v0.1.4 æºç åˆ†æ

---

## 1. æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AgentLoop (loop.py)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  MessageBus  â”‚  â”‚  ToolRegistryâ”‚  â”‚  SessionManager      â”‚  â”‚
â”‚  â”‚  (æ¶ˆæ¯æ€»çº¿)   â”‚  â”‚  (å·¥å…·æ³¨å†Œ)   â”‚  â”‚  (ä¼šè¯ç®¡ç†)           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                   â–¼                   â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚SubagentMgr  â”‚     â”‚ContextBuilderâ”‚    â”‚MemoryStore â”‚
   â”‚(å­ä»£ç†ç®¡ç†)  â”‚     â”‚(ä¸Šä¸‹æ–‡æ„å»º)   â”‚     â”‚(è®°å¿†ç³»ç»Ÿ)   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 2.1 AgentLoop - ä¸»å¾ªç¯ (`loop.py`)

**æ–‡ä»¶ä½ç½®**: `nanobot/agent/loop.py`

**èŒè´£**ï¼šæ§åˆ¶ agent çš„ä¸»æ‰§è¡Œå¾ªç¯ï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒå¼•æ“

**æ ¸å¿ƒæ–¹æ³•**ï¼š

- `run()` - å¯åŠ¨ä¸»å¾ªç¯ï¼Œç›‘å¬æ¶ˆæ¯
- `_run_agent_loop()` - æ‰§è¡Œ LLM + å·¥å…·è°ƒç”¨è¿­ä»£
- `_process_message()` - å¤„ç†å•æ¡æ¶ˆæ¯

**è¿­ä»£æµç¨‹**ï¼š

```python
while iteration < max_iterations:
    1. è°ƒç”¨ LLM (provider.chat)
    2. æ£€æŸ¥æ˜¯å¦æœ‰ tool_calls
    3. æœ‰å·¥å…·è°ƒç”¨ â†’ æ‰§è¡Œå·¥å…· â†’ å°†ç»“æœåŠ å…¥æ¶ˆæ¯ â†’ ç»§ç»­å¾ªç¯
    4. æ— å·¥å…·è°ƒç”¨ â†’ è¿”å›æœ€ç»ˆå›å¤ â†’ é€€å‡ºå¾ªç¯
```

**å…³é”®ç‰¹æ€§**ï¼š

1. **æ€è€ƒå— stripping**ï¼šè‡ªåŠ¨ç§»é™¤ `<thinking>` æ ‡è®°
   - æŸäº›æ¨¡å‹ï¼ˆå¦‚ DeepSeekï¼‰ä¼šåœ¨å“åº”ä¸­åµŒå…¥æ€è€ƒè¿‡ç¨‹
   - è¿™äº›å†…å®¹ä¸åº”æš´éœ²ç»™ç”¨æˆ·

2. **å·¥å…·ç»“æœæˆªæ–­**ï¼šé¿å…è¿‡é•¿çš„å·¥å…·è¾“å‡ºæ±¡æŸ“ä¸Šä¸‹æ–‡
   - è¶…è¿‡é™åˆ¶çš„è¾“å‡ºä¼šè¢«æˆªæ–­

3. **è¿›åº¦å›è°ƒ**ï¼šé€šè¿‡ `on_progress` å®æ—¶æ¨é€ä¸­é—´ç»“æœ
   - æ”¯æŒæµå¼è¾“å‡º

---

### 2.2 ContextBuilder - ä¸Šä¸‹æ–‡æ„å»º (`context.py`)

**æ–‡ä»¶ä½ç½®**: `nanobot/agent/context.py`

**èŒè´£**ï¼šç»„è£…å‘é€ç»™ LLM çš„å®Œæ•´æ¶ˆæ¯åˆ—è¡¨ï¼Œæ˜¯ prompt engineering çš„æ ¸å¿ƒ

**ç³»ç»Ÿæç¤ºè¯ç»„æˆ**ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š

| ä¼˜å…ˆçº§ | æ–‡ä»¶ | ç”¨é€” |
|--------|------|------|
| 1 | `IDENTITY.md` | æ ¸å¿ƒèº«ä»½å®šä¹‰ |
| 2 | `AGENTS.md` | agent è¡Œä¸ºè§„èŒƒ |
| 3 | `SOUL.md` | äººæ ¼/ä»·å€¼è§‚ |
| 4 | `USER.md` | ç”¨æˆ·ä¿¡æ¯ |
| 5 | `TOOLS.md` | å·¥å…·å®šä¹‰ |
| 6 | `MEMORY.md` | é•¿æœŸè®°å¿† |
| 7 | Active Skills | å§‹ç»ˆåŠ è½½çš„æŠ€èƒ½ |
| 8 | Skills Summary | æŠ€èƒ½ç´¢å¼• |

**æ¶ˆæ¯æ„å»ºæµç¨‹**ï¼š

```python
return [
    {"role": "system", "content": build_system_prompt()},
    ...history,  # ä¹‹å‰å¯¹è¯
    {"role": "user", "content": "[Runtime Context]"},
    {"role": "user", "content": current_message},
]
```

**Runtime Context** - ä¸å¯ä¿¡çš„å…ƒæ•°æ®ï¼š

- åŒ…å«æ—¶é—´ã€æ¸ é“ã€èŠå¤© ID
- æ”¾åœ¨ç”¨æˆ·æ¶ˆæ¯å‰ï¼Œä½†æ˜ç¡®æ ‡æ³¨ "metadata only, not instructions"
- é˜²æ­¢ prompt injection æ”»å‡»

---

### 2.3 SubagentManager - å­ä»£ç†ç®¡ç† (`subagent.py`)

**æ–‡ä»¶ä½ç½®**: `nanobot/agent/subagent.py`

**èŒè´£**ï¼šåœ¨åå°æ‰§è¡Œç‹¬ç«‹ä»»åŠ¡ï¼Œå®ç°ä»»åŠ¡çš„å¹¶è¡Œå¤„ç†

**ä½¿ç”¨åœºæ™¯**ï¼š

- éœ€è¦é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡
- éœ€è¦å¹¶è¡Œå¤„ç†å¤šä¸ªè¯·æ±‚
- ä¸ä¸»å¾ªç¯è§£è€¦çš„ç‹¬ç«‹ä»»åŠ¡

**å·¥ä½œæµç¨‹**ï¼š

```
spawn(task) 
    â†’ åˆ›å»º asyncio.Task
    â†’ é™åˆ¶å·¥å…·é›†ï¼ˆæ—  message/spawn å·¥å…·ï¼‰
    â†’ æœ€å¤š 15 æ¬¡è¿­ä»£
    â†’ é€šè¿‡ MessageBus é€šçŸ¥ä¸» agent
```

**å­ä»£ç†å¯ç”¨å·¥å…·**ï¼š

- `read_file` / `write_file` / `edit_file` / `list_dir`
- `exec` (Shell å‘½ä»¤)
- `web_search` / `web_fetch`

**å­ä»£ç†é™åˆ¶**ï¼š

- ä¸èƒ½å‘é€æ¶ˆæ¯ï¼ˆé˜²æ­¢æ— é™å¾ªç¯ï¼‰
- ä¸èƒ½æ´¾ç”Ÿæ–°çš„å­ä»£ç†
- æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼š15

---

### 2.4 MemoryStore - åŒå±‚è®°å¿†ç³»ç»Ÿ (`memory.py`)

**æ–‡ä»¶ä½ç½®**: `nanobot/agent/memory.py`

**è®¾è®¡ç†å¿µ**ï¼šä¸¤å±‚è®°å¿†æ¶æ„ï¼Œæ¨¡æ‹Ÿäººç±»è®°å¿†æœºåˆ¶

| å±‚çº§ | æ–‡ä»¶ | ç”¨é€” | ç‰¹ç‚¹ |
|------|------|------|------|
| **Long-term** | `memory/MEMORY.md` | é•¿æœŸäº‹å® | å§‹ç»ˆåŠ è½½åˆ°ä¸Šä¸‹æ–‡ |
| **History** | `memory/HISTORY.md` | äº‹ä»¶æ—¥å¿— | å¯æœç´¢ï¼ŒæŒ‰éœ€åŠ è½½ |

**Memory Consolidationï¼ˆè®°å¿†æ•´åˆï¼‰æµç¨‹**ï¼š

```python
å½“æœªæ•´åˆæ¶ˆæ¯ >= memory_window æ—¶:
    1. æå–æ—§æ¶ˆæ¯
    2. è°ƒç”¨ LLM åˆ†æå…³é”®ä¿¡æ¯
    3. LLM è°ƒç”¨ save_memory å·¥å…·
    4. æ›´æ–° MEMORY.md + è¿½åŠ åˆ° HISTORY.md
    5. æ ‡è®°å·²æ•´åˆä½ç½®
```

**è§¦å‘æ¡ä»¶**ï¼š

- ç”¨æˆ·å‘é€ `/new` - å¼ºåˆ¶å½’æ¡£æ‰€æœ‰è®°å¿†
- è¾¾åˆ° `memory_window` é˜ˆå€¼ï¼ˆé»˜è®¤é…ç½®ï¼‰

**save_memory å·¥å…·**ï¼š

```python
{
    "name": "save_memory",
    "description": "Save markdown content to the long-term memory file",
    "parameters": {
        "content": "è¦ä¿å­˜çš„å†…å®¹ (markdownæ ¼å¼)"
    }
}
```

---

## 3. å·¥å…·ç³»ç»Ÿ (`tools/`)

### 3.1 å·¥å…·æ³¨å†Œè¡¨ (`registry.py`)

```python
class ToolRegistry:
    def register(self, tool: BaseTool)      # æ³¨å†Œå·¥å…·
    def get(self, name: str) -> BaseTool      # è·å–å·¥å…·
    def get_definitions() -> list             # è¿”å› OpenAI æ ¼å¼å®šä¹‰
    async def execute(name: str, args: dict) # æ‰§è¡Œå·¥å…·
```

### 3.2 å†…ç½®å·¥å…·ä¸€è§ˆ

| å·¥å…· | åŠŸèƒ½ | å®‰å…¨æ€§ |
|------|------|--------|
| `read_file` | è¯»å–æ–‡ä»¶ | âœ… å®‰å…¨ |
| `write_file` | å†™å…¥æ–‡ä»¶ | âš ï¸ éœ€é™åˆ¶è·¯å¾„ |
| `edit_file` | ç¼–è¾‘æ–‡ä»¶ | âš ï¸ éœ€é™åˆ¶è·¯å¾„ |
| `list_dir` | åˆ—å‡ºç›®å½• | âœ… å®‰å…¨ |
| `exec` | æ‰§è¡Œ Shell å‘½ä»¤ | ğŸ”´ å±é™© |
| `web_search` | æœç´¢ç½‘é¡µ | âœ… å®‰å…¨ |
| `web_fetch` | è·å–ç½‘é¡µå†…å®¹ | âœ… å®‰å…¨ |
| `message` | å‘é€æ¶ˆæ¯ | âœ… å®‰å…¨ |
| `spawn` | æ´¾ç”Ÿå­ä»£ç† | âœ… å®‰å…¨ |
| `cron` | å®šæ—¶ä»»åŠ¡ | âœ… å®‰å…¨ |

### 3.3 å·¥å…·æ‰§è¡Œæµç¨‹

```
LLM å“åº”åŒ…å« tool_calls
    â†“
ToolRegistry.execute(name, args)
    â†“
BaseTool.execute(**kwargs)
    â†“
è¿”å›ç»“æœï¼ˆè½¬ä¸º stringï¼‰
    â†“
æ·»åŠ åˆ° messages åˆ—è¡¨
    â†“
ç»§ç»­ä¸‹ä¸€æ¬¡ LLM è°ƒç”¨
```

---

## 4. ä¼šè¯ç®¡ç† (`session/`)

**æ–‡ä»¶ä½ç½®**: `nanobot/session/`

```python
class Session:
    key: str                    # "channel:chat_id" å”¯ä¸€æ ‡è¯†
    messages: list[dict]        # æ¶ˆæ¯å†å²
    last_consolidated: int      # ä¸Šæ¬¡æ•´åˆçš„ä½ç½®
    created_at: datetime        # åˆ›å»ºæ—¶é—´
    updated_at: datetime        # æ›´æ–°æ—¶é—´
```

**ä¼šè¯æŒä¹…åŒ–**ï¼šSQLite æ•°æ®åº“

**ä¼šè¯ç”Ÿå‘½å‘¨æœŸ**ï¼š

1. æ”¶åˆ°æ¶ˆæ¯ â†’ æŸ¥æ‰¾/åˆ›å»º Session
2. å¤„ç†æ¶ˆæ¯ â†’ æ›´æ–° Session
3. å®šæœŸæ•´åˆ â†’ å‹ç¼©å†å²åˆ°è®°å¿†

---

## 5. æ¶ˆæ¯æ€»çº¿ (`bus/`)

**æ–‡ä»¶ä½ç½®**: `nanobot/bus/`

```python
class MessageBus:
    async def publish_inbound(msg)    # æ¥æ”¶å¤–éƒ¨æ¶ˆæ¯
    async def publish_outbound(msg)   # å‘é€å›å¤
    async def consume_inbound()       # æ¶ˆè´¹è¾“å…¥
```

**æ”¯æŒçš„æ¸ é“**ï¼š

- `telegram` - Telegram Bot API
- `discord` - Discord Bot
- `cli` - å‘½ä»¤è¡Œ
- `system` - ç³»ç»Ÿå†…éƒ¨

---

## 6. å…³é”®æ‰§è¡Œæµç¨‹ï¼ˆå®Œæ•´ç‰ˆï¼‰

```
ç”¨æˆ·æ¶ˆæ¯ (Telegram/Discord/CLI)
    â†“
InboundMessage (æ ‡å‡†åŒ–æ¶ˆæ¯æ ¼å¼)
    â†“
Session è·å–/åˆ›å»º (key = channel:chat_id)
    â†“
ContextBuilder.build_messages()
    â”‚   â”œâ”€â”€ åŠ è½½ç³»ç»Ÿæç¤ºè¯
    â”‚   â”œâ”€â”€ åŠ è½½è®°å¿†
    â”‚   â””â”€â”€ åŠ è½½å†å²æ¶ˆæ¯
    â†“
AgentLoop._run_agent_loop()
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼                 â–¼
LLM è°ƒç”¨          æœ‰ tool_calls?
    â”‚                 â”‚
    â”‚                 â”œâ”€ Yes â†’ æ‰§è¡Œå·¥å…· â†’ æ·»åŠ ç»“æœ â†’ ç»§ç»­å¾ªç¯
    â”‚                 â”‚
    â””â”€ No â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¿”å›æœ€ç»ˆå›å¤
    â†“
Session ä¿å­˜ (memory + history)
    â†“
OutboundMessage â†’ å‘é€å›æ¸ é“
```

---

## 7. é…ç½®ç³»ç»Ÿ (`config/`)

**æ–‡ä»¶ä½ç½®**: `nanobot/config/`

```json
{
    "name": "nanobot",
    "llm": {
        "provider": "openai",
        "model": "gpt-4"
    },
    "channels": ["telegram"],
    "tools": {
        "enabled": ["read_file", "write_file", ...],
        "filesystem": {
            "restrict_to_workspace": true
        }
    },
    "memory": {
        "path": "./memory",
        "window": 50
    }
}
```

---

## 8. MCP é›†æˆ

Nanobot æ”¯æŒ MCP (Model Context Protocol)ï¼š

**æ”¯æŒçš„ MCP æœåŠ¡**ï¼š

- Notion - ç¬”è®°/æ•°æ®åº“ç®¡ç†
- å°çº¢ä¹¦ (PigBun) - å†…å®¹å‘å¸ƒ
- SiliconFlow - AI ç”Ÿå›¾
- Gmail - é‚®ä»¶/å­¦æœ¯é€šçŸ¥

**MCP å·¥å…·è°ƒç”¨æµç¨‹**ï¼š

```
MCP Server (å¤–éƒ¨æœåŠ¡)
    â†“
nanobot MCP Bridge
    â†“
ToolRegistry æ³¨å†Œ
    â†“
LLM é€šè¿‡æ ‡å‡†å·¥å…·æ¥å£è°ƒç”¨
```

---

## 9. å…³é”®æŠ€æœ¯äº®ç‚¹

### 9.1 å¼‚æ­¥æ¶æ„

- åŸºäº `asyncio` çš„å¼‚æ­¥å¤„ç†
- æ”¯æŒå¹¶å‘æ¶ˆæ¯å¤„ç†

### 9.2 è®°å¿†æ•´åˆ

- LLM é©±åŠ¨çš„è‡ªåŠ¨æ‘˜è¦
- é¿å…ä¸Šä¸‹æ–‡è†¨èƒ€

### 9.3 å·¥å…·å®‰å…¨

- æ–‡ä»¶ç³»ç»Ÿè·¯å¾„é™åˆ¶
- Shell å‘½ä»¤ç™½åå•

### 9.4 å¤šæ¸ é“ç»Ÿä¸€

- ç»Ÿä¸€çš„æ¶ˆæ¯æ ¼å¼
- å¯æ‰©å±•çš„æ¸ é“æ’ä»¶

---

## 10. ä»£ç ç»“æ„æ€»è§ˆ

```
nanobot/
â”œâ”€â”€ agent/               # Agent æ ¸å¿ƒ
â”‚   â”œâ”€â”€ loop.py         # ä¸»å¾ªç¯ â­
â”‚   â”œâ”€â”€ context.py      # ä¸Šä¸‹æ–‡æ„å»º â­
â”‚   â”œâ”€â”€ subagent.py     # å­ä»£ç†ç®¡ç† â­
â”‚   â”œâ”€â”€ memory.py       # è®°å¿†ç³»ç»Ÿ â­
â”‚   â”œâ”€â”€ skills.py       # æŠ€èƒ½åŠ è½½
â”‚   â”œâ”€â”€ tools/          # å·¥å…·å®ç°
â”‚   â”‚   â”œâ”€â”€ registry.py # å·¥å…·æ³¨å†Œè¡¨
â”‚   â”‚   â”œâ”€â”€ filesystem.py
â”‚   â”‚   â”œâ”€â”€ shell.py
â”‚   â”‚   â”œâ”€â”€ web.py
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ session/        # ä¼šè¯ç®¡ç†
â”œâ”€â”€ bus/                # æ¶ˆæ¯æ€»çº¿
â”‚   â”œâ”€â”€ events.py
â”‚   â”œâ”€â”€ queue.py
â”‚   â””â”€â”€ bridge.py
â”œâ”€â”€ channels/           # æ¸ é“å®ç°
â”‚   â”œâ”€â”€ telegram.py
â”‚   â”œâ”€â”€ discord.py
â”‚   â””â”€â”€ cli.py
â”œâ”€â”€ config/             # é…ç½®ç®¡ç†
â”œâ”€â”€ providers/          # LLM æä¾›å•†
â”‚   â”œâ”€â”€ openai.py
â”‚   â”œâ”€â”€ anthropic.py
â”‚   â””â”€â”€ base.py
â””â”€â”€ utils/              # å·¥å…·å‡½æ•°
```

---

*æ–‡æ¡£ç‰ˆæœ¬: 2026-03-01*
*åŸºäº nanobot-ai v0.1.4 æºç *
